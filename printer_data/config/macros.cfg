[gcode_macro Case_Light_Full]
gcode:
  SET_PIN PIN=caselight VALUE=1.00

[gcode_macro Case_Light_Half]
gcode:
  SET_PIN PIN=caselight VALUE=0.5

[gcode_macro Case_Light_OFF]
gcode:
  SET_PIN PIN=caselight VALUE=0

[gcode_macro G32]
gcode:
    G28
    QUAD_GANTRY_LEVEL
    G28

[gcode_macro QUAD_GANTRY_SCAN]
gcode:
    G28
    QUAD_GANTRY_LEVEL horizontal_move_z=10 retry_tolerance=1.000
    QUAD_GANTRY_LEVEL horizontal_move_z=2
    G28

[gcode_macro M600]
gcode:
    {% set X = params.X|default(50)|float %}
    {% set Y = params.Y|default(0)|float %}
    {% set Z = params.Z|default(10)|float %}
    SAVE_GCODE_STATE NAME=M600_state
    PAUSE
    G91
    G1 E-.8 F2700
    G1 Z{Z}
    G90
    G1 X{X} Y{Y} F3000
    G91
    G1 E-50 F1000
    RESTORE_GCODE_STATE NAME=M600_state

##Slicer GCODE
[gcode_macro START_PRINT_SUPER_SLICER]
variable_bed_temp: 85
variable_extruder_temp: 265
gcode:
    #Turn Lights On!
    Case_Light_Half
    # Use absolute coordinates
    G90
    BED_MESH_CLEAR
    SET_GCODE_OFFSET Z=0

    M104 S150
    
    G28     ; home axes
    G0 Z2   ; position beacon at 2mm for heat soak

    M140 S{bed_temp}     ; start bed heater
    M109 S150       ; preheat nozzle to probing temp
    M190 S{bed_temp}    ; wait on bed temperature
    G4 P60000       ; optional, let temps settle for 1 min

    #WIPE_NOZZLE     ; call another macro to wipe nozzle if available

    G28 Z METHOD=CONTACT CALIBRATE=1    ; calibrate z offset and beacon model hot
    QUAD_GANTRY_SCAN                    ; or QGL to balance towers
    BED_MESH_CALIBRATE RUNS=2           ; bed mesh in scan mode

    #WIPE_NOZZLE
    G28 Z METHOD=CONTACT CALIBRATE=0    ; calibrate z offset only after tilt/mesh

    M104 S{extruder_temp}                   ; set extruder to print temp
    M109 S{extruder_temp}                    ; wait for extruder temp

    SET_GCODE_OFFSET Z=0.06     ; add a little offset for hotend thermal expansion
                            ; needs fine tuning, long meltzones require more
    #SET_GCODE_OFFSET Z_ADJUST={OFFSET}  ; apply optional material squish via slicer
    # Reset Extruder
    G92 E0
    # Move Z Axis up
    #G1 Z2.0 F3000
    # Move to start position
    #G1 X2.1 Y20 Z0.28 F5000.0
    # Draw the first line
    #G1 X2.1 Y200.0 Z0.28 F1500.0 E15
    # Move to side a little
    #G1 X2.4 Y200.0 Z0.28 F5000.0
    # Draw the second line
    #G1 X2.4 Y20 Z0.28 F1500.0 E30

    LINE_PURGE 

    # Reset Extruder
    G92 E0
    M83 ; Tell printer to use relative extrusion
    # Move Z Axis up
    #G1 Z2.0 F3000
    
[gcode_macro END_PRINT]
gcode:
    # Turn off bed, extruder, and fan
    M140 S0
    M104 S0
    M106 S0
    # Move nozzle away from print while retracting
    G91
    G1 X-2 Y-2 E-3 F300
    # Raise nozzle by 10mm
    G1 Z10 F3000
    G90
    #Turn Lights Off!
    Case_Light_OFF
    _TOOLHEAD_PARK_PAUSE_CANCEL
    # Disable steppers
    M84